name: Gemini AI Auto Blog Publisher with GSC Indexing
on:
  push:
    branches: [ master ]
  schedule:
    - cron: "0 */23 * * *"  # Every 23 hours
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      # ===================================================================
      # RESTORE CHROME PROFILE FROM GITHUB ACTIONS CACHE (SECURE!)
      # This keeps your login cookies private even in public repos
      # ===================================================================
      - name: Restore Chrome Profile from Cache
        id: cache-chrome-profile
        uses: actions/cache@v3
        with:
          path: chrome_profile
          key: gsc-chrome-profile-${{ github.repository }}
          restore-keys: |
            gsc-chrome-profile-
      
      - name: Check Chrome Profile Status
        run: |
          if [ -d "chrome_profile" ]; then
            echo "‚úÖ Chrome profile loaded from cache"
            ls -lah chrome_profile/ | head -5
          else
            echo "‚ö†Ô∏è  Chrome profile not found in cache"
            echo "    You need to set this up once - see instructions below"
            echo ""
            echo "üìã First-time setup instructions:"
            echo "1. Run locally: python scripts/first_time_gsc_login.py"
            echo "2. This creates chrome_profile/ folder"
            echo "3. Manually upload chrome_profile/ to GitHub Actions cache:"
            echo "   - Go to Actions tab"
            echo "   - Run 'Setup Chrome Profile' workflow"
            echo "   - This will cache your profile securely"
          fi
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core fonts-dejavu-extra
          
          # Install Chrome for Selenium (GSC automation)
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          echo "‚úÖ Chrome installed successfully"
          google-chrome --version
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install google-genai pillow requests google-auth google-api-python-client tweepy instagrapi
          
          # Install Selenium and webdriver-manager for GSC automation
          pip install selenium webdriver-manager
          
          echo "‚úÖ All dependencies installed"
      
      - name: Verify environment
        run: |
          echo "=== Python Version ==="
          python --version
          echo ""
          echo "=== Chrome Version ==="
          google-chrome --version
          echo ""
          echo "=== Chrome Profile Status ==="
          if [ -d "chrome_profile" ]; then
            echo "‚úÖ chrome_profile exists (loaded from cache)"
          else
            echo "‚ö†Ô∏è  chrome_profile not found - GSC indexing will be skipped"
          fi
      
      - name: Create Chrome profile directory (if not cached)
        run: |
          mkdir -p ./chrome_profile
          echo "Chrome profile directory ready"
      
      - name: Generate blog post with GSC indexing
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FREEPIK_API_KEY: ${{ secrets.FREEPIK_API_KEY }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
          TWITTER_USERNAME: ${{ secrets.TWITTER_USERNAME }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_PERSON_ID: ${{ secrets.LINKEDIN_PERSON_ID }}
          WEBPUSHR_API_KEY: ${{ secrets.WEBPUSHR_API_KEY }}
          WEBPUSHR_AUTH_TOKEN: ${{ secrets.WEBPUSHR_AUTH_TOKEN }}
        run: |
          echo "üöÄ Starting blog post generation with GSC indexing"
          python scripts/generate_posts.py
      
      # ===================================================================
      # SAVE UPDATED CHROME PROFILE BACK TO CACHE
      # This preserves the session for next run
      # ===================================================================
      - name: Save Chrome Profile to Cache
        if: always()
        uses: actions/cache/save@v3
        with:
          path: chrome_profile
          key: gsc-chrome-profile-${{ github.repository }}-${{ github.run_id }}
      
      - name: Verify generated files
        run: |
          echo "üìã Generated posts:"
          ls -lh _posts/ | tail -5
          echo ""
          echo "üñºÔ∏è Generated images:"
          ls -lh assets/images/ | tail -5
          echo ""
          echo "üì∏ Debug screenshots (if any):"
          ls -lh debug_*.png 2>/dev/null || echo "No debug screenshots"
      
      - name: Upload screenshots as artifacts (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gsc-screenshots
          path: debug_*.png
          if-no-files-found: ignore
      
      - name: Commit & Push changes
        run: |
          git config user.name "gemini-blog-bot"
          git config user.email "bot@github.com"
          
          # Pull latest changes first to avoid conflicts
          git pull --rebase origin master || echo "Already up to date"
          
          # Add everything (posts, images, GSC progress) - but NOT chrome_profile
          git add _posts/ assets/ gsc_progress.json 2>/dev/null || true
          
          # Show status
          echo "=== Git Status ==="
          git status
          echo ""
          
          # Commit if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            COMMIT_MSG="ü§ñ Auto-post with GSC indexing: $(date +'%Y-%m-%d %H:%M UTC')"
            git commit -m "$COMMIT_MSG"
            
            echo "üì§ Pushing changes..."
            git push origin master
            
            echo "‚úÖ Changes pushed successfully"
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi