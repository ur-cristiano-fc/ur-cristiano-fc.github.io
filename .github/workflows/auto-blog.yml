name: Gemini AI Auto Blog Publisher with GSC Indexing

on:
  push:
    branches: [ master ]
  schedule:
    - cron: "0 */23 * * *"  # Every 23 hours
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      # ===================================================================
      # FIXED: Restore Chrome Profile with proper cache key
      # ===================================================================
      - name: Restore Chrome Profile from Cache
        id: cache-chrome-profile
        uses: actions/cache/restore@v3
        with:
          path: chrome_profile
          # Use a static key (not run-specific) so it persists across runs
          key: gsc-chrome-profile-v2
          restore-keys: |
            gsc-chrome-profile-v2
            gsc-chrome-profile-
      
      - name: Check Chrome Profile Status
        run: |
          if [ -d "chrome_profile" ] && [ "$(ls -A chrome_profile)" ]; then
            echo "âœ… Chrome profile loaded from cache"
            echo "ðŸ“ Profile contents:"
            ls -lah chrome_profile/ | head -10
            echo ""
            echo "ðŸ“Š Profile size:"
            du -sh chrome_profile/
          else
            echo "âŒ Chrome profile not found or empty!"
            echo ""
            echo "ðŸ“‹ Setup instructions:"
            echo "1. Clone repo locally"
            echo "2. Run: python3 scripts/first_time_gsc_login.py"
            echo "3. This creates chrome_profile/ folder with login cookies"
            echo "4. Run workflow once manually to cache the profile"
            echo "5. Check 'Save Chrome Profile' step succeeds"
            exit 1
          fi
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          
          # Install Chrome for Selenium
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Install fonts for better rendering
          sudo apt-get install -y fonts-dejavu-core fonts-dejavu-extra fontconfig
          
          echo "âœ… Chrome installed"
          google-chrome --version
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install google-genai pillow requests google-auth google-api-python-client
          pip install selenium webdriver-manager
          
          # Install undetected-chromedriver for better anti-detection
          pip install undetected-chromedriver
          
          echo "âœ… Dependencies installed"
      
      - name: Verify Chrome Profile Permissions
        run: |
          # Fix permissions on chrome_profile
          chmod -R 755 chrome_profile/ 2>/dev/null || true
          
          echo "âœ… Chrome profile permissions fixed"
      
      - name: Generate blog post with GSC indexing
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FREEPIK_API_KEY: ${{ secrets.FREEPIK_API_KEY }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
          TWITTER_USERNAME: ${{ secrets.TWITTER_USERNAME }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_PERSON_ID: ${{ secrets.LINKEDIN_PERSON_ID }}
          WEBPUSHR_API_KEY: ${{ secrets.WEBPUSHR_API_KEY }}
          WEBPUSHR_AUTH_TOKEN: ${{ secrets.WEBPUSHR_AUTH_TOKEN }}
        run: |
          echo "ðŸš€ Starting blog post generation with GSC indexing"
          
          # Set display for headless Chrome
          export DISPLAY=:99
          
          python scripts/generate_posts.py
      
      # ===================================================================
      # FIXED: Save Chrome Profile with static key (not run-specific)
      # ===================================================================
      - name: Save Chrome Profile to Cache
        if: always()
        uses: actions/cache/save@v3
        with:
          path: chrome_profile
          # Use same static key so next run can find it
          key: gsc-chrome-profile-v2
      
      - name: Verify generated files
        run: |
          echo "ðŸ“‹ Generated posts:"
          ls -lh _posts/ | tail -5 || echo "No posts found"
          echo ""
          echo "ðŸ–¼ï¸ Generated images:"
          ls -lh assets/images/ | tail -5 || echo "No images found"
          echo ""
          echo "ðŸ“¸ Debug screenshots:"
          ls -lh debug_*.png 2>/dev/null || echo "No debug screenshots"
          echo ""
          echo "ðŸ“Š GSC Progress:"
          cat gsc_progress.json 2>/dev/null || echo "No GSC progress file"
      
      - name: Upload screenshots as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gsc-screenshots-${{ github.run_number }}
          path: debug_*.png
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Upload GSC progress as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gsc-progress-${{ github.run_number }}
          path: gsc_progress.json
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Commit & Push changes
        run: |
          git config user.name "gemini-blog-bot"
          git config user.email "bot@github.com"
          
          # Pull latest changes first
          git pull --rebase origin master || echo "Already up to date"
          
          # Add generated content (NOT chrome_profile - that's cached separately)
          git add _posts/ assets/ gsc_progress.json 2>/dev/null || true
          
          # Show what will be committed
          echo "=== Git Status ==="
          git status
          echo ""
          
          # Commit if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            COMMIT_MSG="ðŸ¤– Auto-post with GSC indexing: $(date +'%Y-%m-%d %H:%M UTC')"
            git commit -m "$COMMIT_MSG"
            
            echo "ðŸ“¤ Pushing changes..."
            git push origin master
            
            echo "âœ… Changes pushed successfully"
          else
            echo "â„¹ï¸  No changes to commit"
          fi
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸ“Š Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "gsc_progress.json" ]; then
            echo "### âœ… GSC Indexing Results" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat gsc_progress.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ No GSC progress file found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "- Posts: $(ls _posts/*.md 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Images: $(ls assets/images/*.webp 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots: $(ls debug_*.png 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY