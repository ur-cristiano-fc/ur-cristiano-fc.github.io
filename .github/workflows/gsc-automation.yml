name: GSC URL Indexing Automation

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      urls:
        description: 'URLs to submit (comma-separated)'
        required: true
        default: 'https://langchain-tutorials.github.io/langchain-production-deployment-staging-to-live-48-hours/'
      domain:
        description: 'Your GSC domain'
        required: true
        default: 'https://langchain-tutorials.github.io/'
      use_domain_property:
        description: 'Use domain property (true/false)'
        required: false
        default: 'false'
      delay:
        description: 'Delay between submissions (seconds)'
        required: false
        default: '15'
  
  # Schedule (optional - runs daily at 2 AM UTC)
  # schedule:
  #   - cron: '0 2 * * *'

jobs:
  index-urls:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager opencv-python pillow
    
    - name: Install Chrome and ChromeDriver
      run: |
        # Install Chrome
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Verify installation
        google-chrome --version
    
    - name: Setup Xvfb (Virtual Display)
      run: |
        sudo apt-get install -y xvfb x11vnc fluxbox
        # Start Xvfb
        Xvfb :99 -screen 0 1920x1080x24 &
        export DISPLAY=:99
        echo "DISPLAY=:99" >> $GITHUB_ENV
        
        # Start a window manager
        fluxbox &
        sleep 2
    
    - name: Setup Chrome Profile Directory
      run: |
        mkdir -p chrome_profile
        mkdir -p recordings
    
    - name: Restore GSC Login Session (if exists)
      uses: actions/cache@v3
      with:
        path: chrome_profile
        key: gsc-chrome-profile-${{ github.repository }}
        restore-keys: |
          gsc-chrome-profile-
    
    - name: Parse URLs from input
      id: parse_urls
      run: |
        # Convert comma-separated URLs to Python list format
        URLS="${{ github.event.inputs.urls }}"
        if [ -z "$URLS" ]; then
          # Use default URLs if not provided (for scheduled runs)
          URLS="https://langchain-tutorials.github.io/langchain-production-deployment-staging-to-live-48-hours/"
        fi
        
        # Create URLs file
        echo "$URLS" | tr ',' '\n' > urls.txt
        cat urls.txt
    
    - name: Create automation script
      run: |
        cat > run_automation.py << 'EOF'
        import sys
        import os
        from gsc_automation import GSCAutomation
        
        # Read URLs from file
        with open('urls.txt', 'r') as f:
            urls = [line.strip() for line in f if line.strip()]
        
        # Get configuration from environment or use defaults
        DOMAIN = os.getenv('GSC_DOMAIN', 'https://langchain-tutorials.github.io/')
        USE_DOMAIN_PROPERTY = os.getenv('USE_DOMAIN_PROPERTY', 'false').lower() == 'true'
        DELAY = int(os.getenv('DELAY', '15'))
        IS_FIRST_RUN = os.getenv('IS_FIRST_RUN', 'false').lower() == 'true'
        
        print(f"Domain: {DOMAIN}")
        print(f"URLs to process: {len(urls)}")
        print(f"Use domain property: {USE_DOMAIN_PROPERTY}")
        print(f"Delay: {DELAY}s")
        print(f"First run: {IS_FIRST_RUN}")
        
        # Initialize bot (headless mode for GitHub Actions)
        bot = GSCAutomation(headless=True, record_video=False)
        
        try:
            if IS_FIRST_RUN:
                print("="*60)
                print("FIRST RUN DETECTED")
                print("="*60)
                print("Manual login required. Please run this locally first.")
                print("Then commit the chrome_profile directory to your repo.")
                sys.exit(1)
            
            # Get property ID
            property_id = bot.get_property_id(DOMAIN, use_domain_property=USE_DOMAIN_PROPERTY)
            print(f"Using property ID: {property_id}")
            
            # Batch submit
            results = bot.batch_submit(
                urls, 
                property_id, 
                delay=DELAY,
                resume=True
            )
            
            # Check results
            if results.get('failed'):
                print("Some URLs failed to submit")
                sys.exit(1)
            
            print("All URLs processed successfully!")
            
        except Exception as e:
            print(f"Error: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        finally:
            bot.close()
        EOF
    
    - name: Run GSC Automation
      env:
        GSC_DOMAIN: ${{ github.event.inputs.domain }}
        USE_DOMAIN_PROPERTY: ${{ github.event.inputs.use_domain_property }}
        DELAY: ${{ github.event.inputs.delay }}
        IS_FIRST_RUN: ${{ secrets.GSC_FIRST_RUN || 'false' }}
      run: |
        export DISPLAY=:99
        python run_automation.py
    
    - name: Upload Progress Files
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gsc-progress-${{ github.run_number }}
        path: |
          gsc_progress.json
          debug_*.png
        retention-days: 30
    
    - name: Upload Recordings (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: recordings-${{ github.run_number }}
        path: recordings/
        retention-days: 7
    
    - name: Save Chrome Profile for Next Run
      uses: actions/cache/save@v3
      if: always()
      with:
        path: chrome_profile
        key: gsc-chrome-profile-${{ github.repository }}-${{ github.run_number }}
    
    - name: Create Summary
      if: always()
      run: |
        echo "## GSC Automation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f gsc_progress.json ]; then
          echo "### Progress Summary" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat gsc_progress.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Screenshots" >> $GITHUB_STEP_SUMMARY
        echo "Check the artifacts for debug screenshots and recordings." >> $GITHUB_STEP_SUMMARY